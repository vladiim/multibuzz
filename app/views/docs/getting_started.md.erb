# Getting Started with Multibuzz

Welcome to Multibuzz! This guide will help you start tracking events and capturing attribution data with automatic UTM extraction, channel attribution, and funnel tracking.

## Overview: How Multibuzz Works

Multibuzz uses **server-side tracking** for maximum accuracy and simplicity:

1. **You send**: Full page URL + referrer (no manual UTM extraction needed!)
2. **Multibuzz extracts**: Visitor IDs, session IDs, UTM parameters, channel attribution
3. **Multibuzz manages**: Cookies, attribution logic, session timeouts
4. **You get**: Clean attribution data without complex client-side code

**Key benefit**: Your integration code is ~50 lines instead of ~500 lines compared to client-side tracking.

---

## 1. Get Your API Key

1. Log in to [your dashboard](<%= dashboard_path %>)
2. Navigate to **API Keys** in the sidebar
3. Click **Generate API Key**
4. Choose your environment:
   - **Test**: For development and testing (1,000 requests/hour)
   - **Live**: For production traffic (10,000 requests/hour)
5. Copy your API key - it will only be shown once!

<% if current_user && current_user.account.api_keys.active.any? %>
Your current API key: `<%= current_user.account.api_keys.active.first.masked_key %>`
<% else %>
Your API key will look like this: `sk_test_a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6`
<% end %>

‚ö†Ô∏è **Important**: Keep your API key secret. Never commit it to version control or expose it in client-side code.

---

## 2. Make Your First API Request

### Simplified API: Just Send URL + Referrer

**No manual visitor/session ID generation needed!** Multibuzz manages these via cookies.

```bash
curl -X POST <%= api_v1_events_url %> \
  -H "Authorization: Bearer YOUR_API_KEY_HERE" \
  -H "Content-Type: application/json" \
  -d '{
    "events": [
      {
        "event_type": "page_view",
        "timestamp": "<%= Time.current.utc.iso8601 %>",
        "url": "https://example.com/pricing?utm_source=google&utm_medium=cpc&utm_campaign=spring_sale",
        "referrer": "https://google.com/search?q=analytics+tool"
      }
    ]
  }'
```

### What Multibuzz Extracts Automatically

From this simple payload, Multibuzz automatically:

‚úÖ **Extracts UTM parameters** from URL:
- `utm_source: "google"`
- `utm_medium: "cpc"`
- `utm_campaign: "spring_sale"`

‚úÖ **Derives channel attribution**:
- `channel: "paid_search"` (from `utm_medium=cpc`)

‚úÖ **Analyzes referrer**:
- `referrer_domain: "google.com"`
- Fallback channel if no UTM: `"organic_search"`

‚úÖ **Captures HTTP request metadata** (server-side):
- **IP address** (anonymized for GDPR compliance)
- **User-Agent** ‚Üí parses device type, browser, OS, version
- **Accept-Language** ‚Üí user's preferred language
- **DNT header** ‚Üí Do Not Track preference
- **Client Hints** (modern browsers) ‚Üí platform, mobile indicator

‚úÖ **Derived device information**:
- Device type: `desktop`, `smartphone`, `tablet`, `bot`
- Browser: `Chrome`, `Safari`, `Firefox`, etc.
- OS: `macOS`, `Windows`, `iOS`, `Android`
- Bot detection (filters out crawlers)

### Expected Response

```json
{
  "accepted": 1,
  "rejected": []
}
```

üéâ **Success!** Your event has been queued for processing.

**Response includes Set-Cookie headers** (transparent to most HTTP clients):
```
Set-Cookie: _multibuzz_vid=vis_abc123...; Expires=...; HttpOnly; Secure
Set-Cookie: _multibuzz_sid=sess_xyz789...; Max-Age=1800; HttpOnly; Secure
```

---

## 3. Understanding the API

### Core Concepts

#### **Visitors**

Anonymous users automatically tracked via `_multibuzz_vid` cookie (set by Multibuzz API).

- **Lifetime**: 1 year
- **Purpose**: Track returning visitors across sessions
- **Privacy**: No PII required - server-generated unique ID

#### **Sessions**

A visit to your site, automatically managed via `_multibuzz_sid` cookie.

- **Lifetime**: 30 minutes of inactivity
- **Purpose**: Group page views and events
- **Attribution**: Captures UTM/referrer on first page view only (first-touch)

New session created when:
- First-time visitor
- Returning visitor after 30+ minutes
- Session cookie expired

#### **Events**

Actions users take. Event types:

- `page_view`: Page loads/views (automatic via middleware)
- `signup`: User registration (Phase 2)
- `purchase`: Completed purchase (Phase 2)
- `trial_started`: Trial sign-up (Phase 2)

#### **Properties**

Custom data attached to events (stored as JSONB).

**You send**:
```json
{
  "url": "https://example.com/pricing?utm_source=google&foo=bar",
  "referrer": "https://google.com",
  "properties": {
    "custom_field": "custom_value"
  }
}
```

**Multibuzz stores**:
```json
{
  "url": "https://example.com/pricing?utm_source=google&foo=bar",
  "utm_source": "google",        // ‚úÖ Extracted from URL
  "utm_medium": null,
  "channel": "organic_search",   // ‚úÖ Derived from referrer
  "custom_field": "custom_value" // Your custom data preserved
}
```

---

## 4. Channel Attribution (No UTM Required!)

Multibuzz automatically derives marketing channels from UTM parameters **or** referrer URLs.

### With UTM Parameters

```json
{
  "url": "https://example.com/?utm_source=facebook&utm_medium=social"
}
```

**Result**: `channel: "organic_social"`

### Without UTM Parameters (Referrer-Based)

```json
{
  "url": "https://example.com/",
  "referrer": "https://google.com/search?q=analytics"
}
```

**Result**: `channel: "organic_search"` (detected from referrer domain)

### Direct Traffic

```json
{
  "url": "https://example.com/",
  "referrer": ""
}
```

**Result**: `channel: "direct"`

### Supported Channels

| Channel | Detection Method |
|---------|------------------|
| `paid_search` | `utm_medium=cpc\|ppc\|paid` |
| `organic_search` | Referrer from Google, Bing, Yahoo, DuckDuckGo |
| `paid_social` | `utm_medium=social` + paid indicators |
| `organic_social` | Referrer from Facebook, LinkedIn, Twitter, etc. |
| `email` | `utm_medium=email` |
| `display` | `utm_medium=display\|banner` |
| `affiliate` | `utm_medium=affiliate` |
| `referral` | External website referrer |
| `video` | Referrer from YouTube, Vimeo |
| `direct` | No referrer, no UTM |

---

## 5. Funnel Tracking

Track users through different conversion funnels (lead gen, subscription, trial, etc.).

### Basic Funnel Tracking

```bash
curl -X POST <%= api_v1_events_url %> \
  -H "Authorization: Bearer YOUR_API_KEY_HERE" \
  -H "Content-Type: application/json" \
  -d '{
    "events": [
      {
        "event_type": "page_view",
        "timestamp": "<%= Time.current.utc.iso8601 %>",
        "url": "https://example.com/pricing",
        "referrer": "https://example.com/",
        "properties": {
          "funnel": "subscription",
          "funnel_step": "pricing_view",
          "funnel_position": 1
        }
      }
    ]
  }'
```

### Funnel Examples

#### Lead Generation Funnel

```json
// Step 1: Landing page
{
  "event_type": "page_view",
  "url": "https://example.com/download-guide",
  "properties": {
    "funnel": "lead",
    "funnel_step": "landing",
    "funnel_position": 1
  }
}

// Step 2: Form view
{
  "event_type": "page_view",
  "url": "https://example.com/download-guide#form",
  "properties": {
    "funnel": "lead",
    "funnel_step": "form_view",
    "funnel_position": 2
  }
}

// Step 3: Conversion
{
  "event_type": "lead_submitted",
  "properties": {
    "funnel": "lead",
    "funnel_step": "conversion",
    "funnel_position": 3,
    "guide_title": "SEO Best Practices 2025"
  }
}
```

#### Subscription Funnel

```json
// Step 1: Pricing page
{
  "event_type": "page_view",
  "url": "https://example.com/pricing",
  "properties": {
    "funnel": "subscription",
    "funnel_step": "pricing_view",
    "funnel_position": 1
  }
}

// Step 2: Checkout started
{
  "event_type": "checkout_started",
  "properties": {
    "funnel": "subscription",
    "funnel_step": "checkout",
    "funnel_position": 2,
    "plan": "pro"
  }
}

// Step 3: Payment completed
{
  "event_type": "subscription_created",
  "properties": {
    "funnel": "subscription",
    "funnel_step": "conversion",
    "funnel_position": 3,
    "plan": "pro",
    "mrr": 9900
  }
}
```

### Multiple Funnels Per Session

Users can progress through different funnels in the same session:

```json
// Morning: Download ebook (lead funnel)
{
  "event_type": "lead_submitted",
  "properties": {
    "funnel": "lead",
    "funnel_step": "conversion"
  }
}

// Afternoon: Start trial (subscription funnel)
{
  "event_type": "trial_started",
  "properties": {
    "funnel": "subscription",
    "funnel_step": "trial_signup"
  }
}
```

### Funnel Field Reference

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `funnel` | String | No | Funnel identifier (e.g., `"subscription"`, `"lead"`) |
| `funnel_step` | String | No | Step name (e.g., `"pricing_view"`, `"conversion"`) |
| `funnel_position` | Integer | No | Numeric position for ordering (1, 2, 3, ...) |

**Naming convention**: Use `snake_case` for funnel and step names.

---

## 6. Enhanced Tracking with Client-Side Data (Optional)

While Multibuzz captures most data server-side, you can optionally enhance tracking with client-side information that isn't available in HTTP headers.

### Screen & Viewport Data

```json
{
  "event_type": "page_view",
  "url": "https://example.com/pricing",
  "referrer": "https://example.com/",
  "properties": {
    "screen_width": 1920,
    "screen_height": 1080,
    "viewport_width": 1440,
    "viewport_height": 900,
    "device_pixel_ratio": 2.0,
    "color_depth": 24
  }
}
```

### Page Metadata

```json
{
  "event_type": "page_view",
  "url": "https://example.com/pricing",
  "properties": {
    "page_title": "Pricing - Acme Inc",
    "page_path": "/pricing",
    "page_referrer": "https://example.com/features"
  }
}
```

### JavaScript Example (Browser)

```javascript
// Capture client-side data
function getClientMetadata() {
  return {
    screen_width: window.screen.width,
    screen_height: window.screen.height,
    viewport_width: window.innerWidth,
    viewport_height: window.innerHeight,
    device_pixel_ratio: window.devicePixelRatio || 1,
    color_depth: window.screen.colorDepth,
    page_title: document.title,
    timezone_offset: new Date().getTimezoneOffset()
  };
}

// Send to Multibuzz API
fetch('https://multibuzz.io/api/v1/events', {
  method: 'POST',
  headers: {
    'Authorization': 'Bearer YOUR_API_KEY',
    'Content-Type': 'application/json'
  },
  body: JSON.stringify({
    events: [{
      event_type: 'page_view',
      timestamp: new Date().toISOString(),
      url: window.location.href,
      referrer: document.referrer,
      properties: getClientMetadata()
    }]
  })
});
```

### What's Captured Automatically vs. Optionally

| Data | Server-Side (Auto) | Client-Side (Optional) |
|------|-------------------|------------------------|
| IP address | ‚úÖ From request | ‚ùå |
| User-Agent | ‚úÖ From headers | ‚ùå |
| Browser/OS | ‚úÖ Parsed from UA | ‚úÖ Can override |
| Language | ‚úÖ Accept-Language header | ‚úÖ Can override |
| Referrer | ‚úÖ From headers | ‚úÖ Can override |
| Screen size | ‚ùå | ‚úÖ Must send |
| Viewport size | ‚ùå | ‚úÖ Must send |
| Page title | ‚ùå | ‚úÖ Must send |
| Timezone | ‚ùå | ‚úÖ Must send |

**Recommendation**: Start with server-side only (simpler). Add client-side metadata later if you need screen/viewport analytics.

---

## 7. Code Examples

### Ruby

```ruby
require 'net/http'
require 'json'

class MultibuzzClient
  API_URL = '<%= api_v1_events_url.gsub('/events', '') %>'

  def initialize(api_key)
    @api_key = api_key
  end

  def track_page_view(url:, referrer: nil, funnel: nil, funnel_step: nil)
    event = {
      event_type: 'page_view',
      timestamp: Time.now.utc.iso8601,
      url: url,
      referrer: referrer,
      properties: {
        funnel: funnel,
        funnel_step: funnel_step
      }.compact
    }

    send_events([event])
  end

  def track_event(event_type, properties: {})
    event = {
      event_type: event_type,
      timestamp: Time.now.utc.iso8601,
      properties: properties
    }

    send_events([event])
  end

  def send_events(events)
    uri = URI("#{API_URL}/events")
    http = Net::HTTP.new(uri.host, uri.port)
    http.use_ssl = true

    request = Net::HTTP::Post.new(uri.path)
    request['Authorization'] = "Bearer #{@api_key}"
    request['Content-Type'] = 'application/json'
    request.body = { events: events }.to_json

    response = http.request(request)
    JSON.parse(response.body)
  end
end

# Usage
client = MultibuzzClient.new(ENV['MULTIBUZZ_API_KEY'])

# Simple page view
result = client.track_page_view(
  url: 'https://example.com/pricing?utm_source=google&utm_medium=cpc',
  referrer: 'https://google.com/search'
)

# Page view with funnel tracking
result = client.track_page_view(
  url: 'https://example.com/pricing',
  referrer: 'https://example.com/',
  funnel: 'subscription',
  funnel_step: 'pricing_view'
)

# Custom event with funnel
result = client.track_event('subscription_created',
  properties: {
    funnel: 'subscription',
    funnel_step: 'conversion',
    plan: 'pro',
    mrr: 9900
  }
)

puts "Accepted: #{result['accepted']}, Rejected: #{result['rejected'].size}"
```

### JavaScript (Node.js)

```javascript
const axios = require('axios');

class MultibuzzClient {
  constructor(apiKey) {
    this.apiKey = apiKey;
    this.apiUrl = '<%= api_v1_events_url.gsub('/events', '') %>';
  }

  async trackPageView({ url, referrer = null, funnel = null, funnelStep = null }) {
    const event = {
      event_type: 'page_view',
      timestamp: new Date().toISOString(),
      url,
      referrer,
      properties: {
        ...(funnel && { funnel }),
        ...(funnelStep && { funnel_step: funnelStep })
      }
    };

    return this.sendEvents([event]);
  }

  async trackEvent(eventType, properties = {}) {
    const event = {
      event_type: eventType,
      timestamp: new Date().toISOString(),
      properties
    };

    return this.sendEvents([event]);
  }

  async sendEvents(events) {
    try {
      const response = await axios.post(
        `${this.apiUrl}/events`,
        { events },
        {
          headers: {
            'Authorization': `Bearer ${this.apiKey}`,
            'Content-Type': 'application/json'
          }
        }
      );

      return response.data;
    } catch (error) {
      if (error.response) {
        throw new Error(`API Error: ${error.response.data.error}`);
      }
      throw error;
    }
  }
}

// Usage
const client = new MultibuzzClient(process.env.MULTIBUZZ_API_KEY);

// Simple page view
client.trackPageView({
  url: 'https://example.com/pricing?utm_source=google',
  referrer: 'https://google.com/search'
}).then(result => {
  console.log(`Accepted: ${result.accepted}`);
});

// Page view with funnel
client.trackPageView({
  url: 'https://example.com/pricing',
  referrer: 'https://example.com/',
  funnel: 'subscription',
  funnelStep: 'pricing_view'
});

// Custom event
client.trackEvent('subscription_created', {
  funnel: 'subscription',
  funnel_step: 'conversion',
  plan: 'pro',
  mrr: 9900
});
```

### Python

```python
import requests
from datetime import datetime, timezone
from typing import Dict, List, Optional

class MultibuzzClient:
    API_URL = '<%= api_v1_events_url.gsub('/events', '') %>'

    def __init__(self, api_key: str):
        self.api_key = api_key

    def track_page_view(
        self,
        url: str,
        referrer: Optional[str] = None,
        funnel: Optional[str] = None,
        funnel_step: Optional[str] = None
    ) -> Dict:
        """Track a page view event."""
        properties = {}
        if funnel:
            properties['funnel'] = funnel
        if funnel_step:
            properties['funnel_step'] = funnel_step

        event = {
            'event_type': 'page_view',
            'timestamp': datetime.now(timezone.utc).isoformat(),
            'url': url,
            'referrer': referrer,
            'properties': properties
        }

        return self.send_events([event])

    def track_event(self, event_type: str, properties: Optional[Dict] = None) -> Dict:
        """Track a custom event."""
        event = {
            'event_type': event_type,
            'timestamp': datetime.now(timezone.utc).isoformat(),
            'properties': properties or {}
        }

        return self.send_events([event])

    def send_events(self, events: List[Dict]) -> Dict:
        """Send one or more events to Multibuzz."""
        response = requests.post(
            f'{self.API_URL}/events',
            json={'events': events},
            headers={
                'Authorization': f'Bearer {self.api_key}',
                'Content-Type': 'application/json'
            }
        )

        response.raise_for_status()
        return response.json()

# Usage
import os

client = MultibuzzClient(os.getenv('MULTIBUZZ_API_KEY'))

# Simple page view
result = client.track_page_view(
    url='https://example.com/pricing?utm_source=google',
    referrer='https://google.com/search'
)

# Page view with funnel
result = client.track_page_view(
    url='https://example.com/pricing',
    referrer='https://example.com/',
    funnel='subscription',
    funnel_step='pricing_view'
)

# Custom event
result = client.track_event('subscription_created', {
    'funnel': 'subscription',
    'funnel_step': 'conversion',
    'plan': 'pro',
    'mrr': 9900
})

print(f"Accepted: {result['accepted']}, Rejected: {len(result['rejected'])}")
```

---

## 7. Check Your Data

After sending events:

1. Go to [your dashboard](<%= dashboard_path %>)
2. View recent events in the **Events** table
3. Check **UTM Breakdown** to see channel attribution
4. Monitor **Stats** for total visitors, sessions, and events

---

## 8. Advanced Usage

### Batch Processing

Send up to 100 events per request for better performance:

```bash
curl -X POST <%= api_v1_events_url %> \
  -H "Authorization: Bearer YOUR_API_KEY_HERE" \
  -H "Content-Type: application/json" \
  -d '{
    "events": [
      {
        "event_type": "page_view",
        "timestamp": "<%= 2.minutes.ago.utc.iso8601 %>",
        "url": "https://example.com/",
        "referrer": "https://google.com/search"
      },
      {
        "event_type": "page_view",
        "timestamp": "<%= 1.minute.ago.utc.iso8601 %>",
        "url": "https://example.com/pricing",
        "referrer": "https://example.com/"
      },
      {
        "event_type": "page_view",
        "timestamp": "<%= Time.current.utc.iso8601 %>",
        "url": "https://example.com/signup",
        "referrer": "https://example.com/pricing"
      }
    ]
  }'
```

### Error Handling

The API returns partial successes. Always check the `rejected` array:

```json
{
  "accepted": 2,
  "rejected": [
    {
      "index": 1,
      "errors": [
        "url is required",
        "timestamp must be a valid ISO8601 datetime"
      ]
    }
  ]
}
```

### Rate Limiting

Monitor rate limit headers in responses:

```
X-RateLimit-Limit: 10000
X-RateLimit-Remaining: 9847
X-RateLimit-Reset: 1699876800
```

If you exceed your rate limit (HTTP 429), wait until the reset time or upgrade your plan.

---

## 9. Best Practices

### ‚úÖ Do

- **Send full URLs**: Include query parameters (Multibuzz extracts UTMs automatically)
- **Include referrer**: Enables fallback attribution when no UTM present
- **Use funnel tracking**: Tag events with funnel context for conversion analysis
- **Send complete URLs**: `https://example.com/page?utm_source=google&foo=bar` (not just `/page`)
- **Use batch requests**: Send multiple events at once for better performance
- **Handle errors gracefully**: Check `rejected` array and retry if needed
- **Use test keys in development**: Keep test and live data separate

### ‚ùå Don't

- **Don't manually extract UTMs**: Send the full URL, let Multibuzz parse it
- **Don't generate visitor/session IDs**: Multibuzz manages these via cookies
- **Don't send PII in URLs**: Filter passwords, emails before sending
- **Don't expose API keys in browser**: Use server-side integration only
- **Don't retry 4xx errors**: These are permanent failures (fix the data instead)
- **Don't ignore rate limits**: Respect the limits or you'll be temporarily blocked

---

## 10. Attribution Models Supported

Multibuzz captures data for multiple attribution models:

### First-Touch Attribution

Credit goes to the first marketing touchpoint.

**Query**: Which channel brought this visitor initially?
**Answer**: `visitor.sessions.order(:started_at).first.channel`

### Last-Touch Attribution

Credit goes to the last touchpoint before conversion.

**Query**: Which channel drove this conversion?
**Answer**: `conversion_event.session.channel`

### Multi-Touch Attribution

Credit distributed across all touchpoints.

**Query**: What was the visitor's journey?
**Answer**: `visitor.sessions.order(:started_at).pluck(:channel, :initial_utm)`

**Example journey**:
1. Session 1: Google Ads (`paid_search`)
2. Session 2: Facebook post (`organic_social`)
3. Session 3: Direct visit ‚Üí **converts** (`direct`)

---

## Next Steps

Now that you're tracking events:

1. **Set up UTM campaigns**: Add UTM parameters to your marketing links (or rely on referrer detection!)
2. **Configure funnels**: Tag events with funnel context to track conversions
3. **Monitor attribution**: See which channels drive the most valuable traffic
4. **Analyze drop-offs**: Identify where users leave your funnels
5. **Export data**: (Coming soon) Export to your data warehouse

Happy tracking! üéâ
