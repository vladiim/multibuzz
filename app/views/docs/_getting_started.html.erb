<%= render_markdown <<~MD
  # Getting Started with Multibuzz

  Server-side multi-touch attribution tracking for your application.

  ---

  ## Quick Start

  ### 1. Get Your API Key

  1. Log in to [your dashboard](#{dashboard_path})
  2. Navigate to **API Keys**
  3. Click **Create API Key**
  4. Choose **Test** environment for development
  5. Copy your API key (starts with `sk_test_...`)

  ---

  ### 2. Install the Client Library
MD
%>

<%= code_tabs({
  ruby: {
    label: 'Ruby',
    syntax: 'ruby',
    code: <<~CODE
      # Gemfile
      gem 'mbuzz'

      # Then run:
      bundle install
    CODE
  },
  curl: {
    label: 'REST API',
    syntax: 'text',
    code: <<~CODE
      No installation needed.
      Use any HTTP client.
    CODE
  }
}, default: :ruby) %>

<%= render_markdown <<~MD
  ---

  ### 3. Configure
MD
%>

<%= code_tabs({
  ruby: {
    label: 'Ruby',
    syntax: 'ruby',
    code: <<~CODE
      # config/initializers/mbuzz.rb
      Mbuzz.configure do |config|
        config.api_key = ENV['MBUZZ_API_KEY']
        config.api_url = 'https://mbuzz.co/api/v1'
        config.enabled = !Rails.env.test?
        config.debug = Rails.env.development?
      end
    CODE
  },
  curl: {
    label: 'REST API',
    syntax: 'bash',
    code: <<~CODE
      # Set your API key as environment variable
      export MBUZZ_API_KEY=sk_test_your_key_here

      # Use in Authorization header
      curl -H "Authorization: Bearer $MBUZZ_API_KEY" \\
           https://mbuzz.co/api/v1/events
    CODE
  }
}, default: :ruby) %>

<%= render_markdown <<~MD
  **⚠️ Security**: Never commit API keys to git. Use environment variables.

  ---

  ### 4. Track Your First Event
MD
%>

<%= code_tabs({
  ruby: {
    label: 'Ruby',
    syntax: 'ruby',
    code: <<~CODE
      # Track a user event
      Mbuzz.track(
        user_id: current_user.id,
        event: 'Signup',
        properties: {
          plan: 'pro',
          trial_days: 14
        }
      )

      # Track anonymous visitor event
      Mbuzz.track(
        visitor_id: mbuzz_visitor_id,  # From gem helper
        event: 'Viewed Pricing',
        properties: {
          source: 'homepage'
        }
      )
    CODE
  },
  curl: {
    label: 'REST API',
    syntax: 'bash',
    code: <<~CODE
      curl -X POST #{api_v1_events_url} \\
        -H "Authorization: Bearer $MBUZZ_API_KEY" \\
        -H "Content-Type: application/json" \\
        -d '{
          "user_id": "123",
          "event_type": "Signup",
          "properties": {
            "plan": "pro",
            "trial_days": 14
          }
        }'
    CODE
  }
}, default: :ruby) %>

<%= render_markdown <<~MD
  ---

  ## Core Concepts

  ### Sessions (The Foundation of Attribution)

  A **session** is a single visit to your site with acquisition context. Sessions are the **touchpoints** used for attribution.

  **What a session captures**:
  - UTM parameters (`utm_source`, `utm_medium`, `utm_campaign`, etc.)
  - Referrer URL (for organic/referral traffic)
  - Channel (derived from UTMs + referrer: `paid_search`, `organic`, `email`, etc.)
  - Landing page

  **Session behavior**:
  - **Auto-created**: SDK middleware creates sessions automatically
  - **30-minute timeout**: New session after 30 min of inactivity
  - **Non-blocking**: Session POST is async (doesn't slow your app)

  **Why sessions matter**: Without sessions, you can't know *how* a visitor arrived. Sessions make multi-touch attribution possible.

  ### Visitors

  Anonymous users tracked via cookies.

  - **Lifetime**: 2 years
  - **Auto-generated**: By SDK (64-char hex, stored in `_mbuzz_vid` cookie)
  - **Thread-safe**: Works with multi-threaded servers
  - **Privacy-first**: No PII required

  A single person may have multiple visitors (multiple devices/browsers).

  ### Users

  Known, identified users in your system.

  - **Cross-device**: One user identity across all devices
  - **Permanent**: Persists beyond cookies
  - **Your ID**: Use your application's user identifier

  Link visitors to users with `Mbuzz.identify()` or `Mbuzz.alias()`.

  ### Events

  Actions users take in your application.

  **Required fields**:
  - `event_type` - Event name (e.g., "signup", "purchase", "add_to_cart")
  - `user_id` OR `visitor_id` - At least one identifier required

  **Recommended fields**:
  - `session_id` - Links event to session for attribution

  **Optional fields**:
  - `properties` - Custom metadata (JSON object)
  - `timestamp` - When event occurred (defaults to now)

  ---

  ## Automatic Session Tracking

  The Ruby gem includes Rack middleware that automatically creates sessions when visitors land on your site.

  **What happens on each request**:
  1. SDK checks for existing visitor cookie (`_mbuzz_vid`)
  2. SDK checks for existing session cookie (`_mbuzz_sid`)
  3. If new session detected → **POST to API** with full context
  4. Cookies refreshed

  **Session context captured automatically**:
  - Full URL (including UTM parameters)
  - Referrer URL
  - User-Agent
  - IP address (for geo lookup)

  **Session detection**:
  - **New visitor**: No `_mbuzz_vid` cookie → new session
  - **Returning visitor, new session**: `_mbuzz_vid` exists but `_mbuzz_sid` missing/expired (30+ min) → new session
  - **Same session**: Both cookies valid → no new session

  **The API handles**:
  - UTM parameter extraction
  - Referrer analysis
  - Channel derivation (`paid_search`, `organic`, `email`, etc.)
  - Visitor/Session record creation

  **Important**: Session POSTs are async and non-blocking. Your page render is not slowed.

  **Disable if needed**:

  ```ruby
  # config/initializers/mbuzz.rb
  Mbuzz.configure do |config|
    config.enabled = false
  end
  ```

  ---

  ## User Identification

  ### Identify

  Associate traits with a user ID:
MD
%>

<%= code_tabs({
  ruby: {
    label: 'Ruby',
    syntax: 'ruby',
    code: <<~CODE
      Mbuzz.identify(
        user_id: current_user.id,
        traits: {
          email: current_user.email,
          name: current_user.name,
          plan: current_user.plan,
          company: current_user.company_name
        }
      )
    CODE
  },
  curl: {
    label: 'REST API',
    syntax: 'bash',
    code: <<~CODE
      curl -X POST #{api_v1_events_url.gsub('/events', '/identify')} \\
        -H "Authorization: Bearer $MBUZZ_API_KEY" \\
        -H "Content-Type: application/json" \\
        -d '{
          "user_id": "123",
          "traits": {
            "email": "user@example.com",
            "name": "Jane Doe",
            "plan": "pro"
          }
        }'
    CODE
  }
}, default: :ruby) %>

<%= render_markdown <<~MD
  **When to call**:
  - On signup
  - On login
  - When user attributes change

  ### Alias

  Link anonymous visitor to user account:
MD
%>

<%= code_tabs({
  ruby: {
    label: 'Ruby',
    syntax: 'ruby',
    code: <<~CODE
      # After successful signup/login
      Mbuzz.alias(
        user_id: current_user.id,
        visitor_id: mbuzz_visitor_id
      )
    CODE
  },
  curl: {
    label: 'REST API',
    syntax: 'bash',
    code: <<~CODE
      curl -X POST #{api_v1_events_url.gsub('/events', '/alias')} \\
        -H "Authorization: Bearer $MBUZZ_API_KEY" \\
        -H "Content-Type: application/json" \\
        -d '{
          "user_id": "123",
          "visitor_id": "abc123def456"
        }'
    CODE
  }
}, default: :ruby) %>

<%= render_markdown <<~MD
  ### What Alias Does (Important!)

  When you call `alias`, you create a **bidirectional link** between visitor and user:

  **Backward attribution**:
  - All past sessions from this visitor are now attributed to the user
  - Sessions from before the user signed up become part of their journey

  **Forward attribution**:
  - All future sessions from this visitor are automatically attributed to the user
  - No need to call alias again on subsequent logins

  ### Cross-Device Tracking

  Users often visit on multiple devices. Each device has a different visitor ID:

  ```
  Desktop visitor (abc) ─────┐
                             ├──→ User (usr_123)
  Mobile visitor (def) ──────┘
  ```

  **How to enable**:
  1. User visits on desktop → visitor `abc` created
  2. User visits on mobile → visitor `def` created
  3. User signs up on mobile → `alias(visitor: def, user: usr_123)`
  4. User logs in on desktop → `alias(visitor: abc, user: usr_123)`
  5. Now both visitors linked → full cross-device attribution

  **Call alias on every login**, not just signup. This ensures visitors from new devices get linked.

  ### Example: Full Journey Attribution

  ```
  Day 1: Jane visits via Google Ads (desktop) → Session A
  Day 3: Jane visits via Facebook (mobile) → Session B
  Day 5: Jane signs up (mobile) → alias() links mobile visitor
  Day 6: Jane logs in (desktop) → alias() links desktop visitor
  Day 7: Jane purchases → Attribution spans ALL sessions (A, B, etc.)
  ```

  Without alias, you'd only see the mobile sessions.

  ---

  ## Conversion Tracking

  Conversions are the key metric for attribution. When a user converts (signup, purchase, etc.),
  the system automatically calculates attribution across all your configured models.

  ### Creating Conversions

  You can create conversions in two ways:

  **Option A: Event-based** (recommended for precise attribution)
MD
%>

<%= code_tabs({
  ruby: {
    label: 'Ruby',
    syntax: 'ruby',
    code: <<~CODE
      # First track the conversion event
      result = Mbuzz::Client.track(
        visitor_id: mbuzz_visitor_id,
        event_type: 'checkout_completed',
        properties: { order_id: order.id }
      )

      # Then create the conversion linked to that event
      if result[:success]
        conversion = Mbuzz::Client.conversion(
          event_id: result[:event_id],
          conversion_type: 'purchase',
          revenue: order.total
        )

        # Access attribution data
        if conversion[:success]
          conversion[:attribution][:models].each do |model, credits|
            puts "\#{model}: \#{credits.map { |c| c[:channel] }.join(', ')}"
          end
        end
      end
    CODE
  },
  curl: {
    label: 'REST API',
    syntax: 'bash',
    code: <<~CODE
      # Create conversion from event
      curl -X POST https://mbuzz.co/api/v1/conversions \\
        -H "Authorization: Bearer $MBUZZ_API_KEY" \\
        -H "Content-Type: application/json" \\
        -d '{
          "conversion": {
            "event_id": "evt_abc123",
            "conversion_type": "purchase",
            "revenue": 99.99
          }
        }'
    CODE
  }
}, default: :ruby) %>

<%= render_markdown <<~MD
  **Option B: Visitor-based** (simpler, for direct conversions)
MD
%>

<%= code_tabs({
  ruby: {
    label: 'Ruby',
    syntax: 'ruby',
    code: <<~CODE
      # Create conversion directly from visitor ID
      # (uses visitor's most recent session)
      conversion = Mbuzz::Client.conversion(
        visitor_id: mbuzz_visitor_id,
        conversion_type: 'purchase',
        revenue: order.total,
        properties: { plan: 'pro' }
      )
    CODE
  },
  curl: {
    label: 'REST API',
    syntax: 'bash',
    code: <<~CODE
      # Create conversion from visitor ID
      curl -X POST https://mbuzz.co/api/v1/conversions \\
        -H "Authorization: Bearer $MBUZZ_API_KEY" \\
        -H "Content-Type: application/json" \\
        -d '{
          "conversion": {
            "visitor_id": "65dabef8d611f332d5bb88f5d6870c733d89f962594575b66f0e1de1ede1ebf0",
            "conversion_type": "purchase",
            "revenue": 99.99
          }
        }'
    CODE
  }
}, default: :ruby) %>

<%= render_markdown <<~MD
  ### Conversion Response

  Successful conversions return attribution data immediately:

  ```json
  {
    "id": "conv_xyz789",
    "conversion_type": "purchase",
    "revenue": "99.99",
    "attribution": {
      "lookback_days": 30,
      "sessions_analyzed": 3,
      "models": {
        "first_touch": [
          { "channel": "organic_search", "credit": 1.0, "revenue_credit": "99.99" }
        ],
        "last_touch": [
          { "channel": "email", "credit": 1.0, "revenue_credit": "99.99" }
        ],
        "linear": [
          { "channel": "organic_search", "credit": 0.333, "revenue_credit": "33.00" },
          { "channel": "paid_social", "credit": 0.333, "revenue_credit": "33.00" },
          { "channel": "email", "credit": 0.334, "revenue_credit": "33.99" }
        ]
      }
    }
  }
  ```

  ### When to Use Each Approach

  | Approach | Use Case |
  |----------|----------|
  | **Event-based** (`event_id`) | Tie conversion to specific action (checkout button click, form submit) |
  | **Visitor-based** (`visitor_id`) | Direct conversions, offline imports, webhook integrations |

  ---

  ## Common Use Cases

  ### E-Commerce Tracking
MD
%>

<%= code_tabs({
  ruby: {
    label: 'Ruby',
    syntax: 'ruby',
    code: <<~CODE
      class OrdersController < ApplicationController
        def create
          @order = current_user.orders.create!(order_params)

          Mbuzz.track(
            user_id: current_user.id,
            event: 'Purchase Completed',
            properties: {
              order_id: @order.id,
              amount: @order.total,
              items: @order.items.count,
              currency: 'USD'
            }
          )

          redirect_to order_path(@order)
        end
      end
    CODE
  },
  curl: {
    label: 'REST API',
    syntax: 'bash',
    code: <<~CODE
      curl -X POST #{api_v1_events_url} \\
        -H "Authorization: Bearer $MBUZZ_API_KEY" \\
        -H "Content-Type: application/json" \\
        -d '{
          "user_id": "123",
          "event_type": "Purchase Completed",
          "properties": {
            "order_id": "order_456",
            "amount": 99.99,
            "items": 2,
            "currency": "USD"
          }
        }'
    CODE
  }
}, default: :ruby) %>

<%= render_markdown <<~MD
  ### SaaS Subscription Tracking
MD
%>

<%= code_tabs({
  ruby: {
    label: 'Ruby',
    syntax: 'ruby',
    code: <<~CODE
      class SubscriptionsController < ApplicationController
        def create
          @subscription = current_user.create_subscription!(
            plan: params[:plan]
          )

          Mbuzz.track(
            user_id: current_user.id,
            event: 'Subscription Created',
            properties: {
              plan: @subscription.plan,
              billing_cycle: @subscription.billing_cycle,
              mrr: @subscription.monthly_revenue
            }
          )

          redirect_to dashboard_path
        end
      end
    CODE
  },
  curl: {
    label: 'REST API',
    syntax: 'bash',
    code: <<~CODE
      curl -X POST #{api_v1_events_url} \\
        -H "Authorization: Bearer $MBUZZ_API_KEY" \\
        -H "Content-Type: application/json" \\
        -d '{
          "user_id": "123",
          "event_type": "Subscription Created",
          "properties": {
            "plan": "pro",
            "billing_cycle": "monthly",
            "mrr": 99.00
          }
        }'
    CODE
  }
}, default: :ruby) %>

<%= render_markdown <<~MD
  ---

  ## Error Handling

  **Client libraries never raise exceptions**. All errors are:

  - Logged (if debug mode enabled)
  - Returned as `false` from tracking methods
  - Silently ignored otherwise

  **Why**: Tracking failures should never break your application.

  **Debugging**:

  ```ruby
  # Enable debug mode
  Mbuzz.configure do |config|
    config.debug = true
  end

  # Check return values
  if Mbuzz.track(user_id: 1, event: 'Test')
    puts "✅ Tracking succeeded"
  else
    puts "❌ Tracking failed (check logs)"
  end
  ```

  ---

  ## Testing

  ### Disable Tracking in Tests
MD
%>

<%= code_tabs({
  ruby: {
    label: 'Ruby',
    syntax: 'ruby',
    code: <<~CODE
      # config/initializers/mbuzz.rb
      Mbuzz.configure do |config|
        config.enabled = !Rails.env.test?
      end
    CODE
  },
  curl: {
    label: 'REST API',
    syntax: 'bash',
    code: <<~CODE
      # No installation needed for REST API.
      # All requests require the Authorization header with your API key.

      export MBUZZ_API_KEY=sk_test_your_key_here
      export MBUZZ_API_URL=https://api.mbuzz.co
    CODE
  }
}, default: :ruby) %>

<%= render_markdown <<~MD
  ---

  ## Next Steps

  Now that you're tracking events:

  1. **View your data** - Check [your dashboard](#{dashboard_path}) for recent events
  2. **Track conversions** - Add tracking for signups, purchases, subscriptions
  3. **Identify users** - Call `identify()` on signup/login
  4. **Link visitors** - Call `alias()` after signup
  5. **Analyze attribution** - See which channels drive conversions

  **Need help?** Check out:
  - [Authentication](#{docs_path('authentication')}) - API key management
  - [API Reference](#{docs_path('api-reference')}) - Full API documentation
  - [Examples](#{docs_path('examples')}) - More integration examples
MD
%>
