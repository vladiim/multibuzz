<%= turbo_frame_tag "conversions_#{current_account.prefix_id}" do %>
  <div class="dashboard-section">
    <% if @result[:success] %>
      <% data = @result[:data] %>
      <% totals = data[:totals] %>
      <% prior = totals[:prior_period] %>

      <!-- KPI Cards as Metric Tabs -->
      <% selected_metric = @filter_params[:metric] %>
      <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
        <%= link_to dashboard_path(request.query_parameters.merge(metric: "conversions")),
            class: "bg-white p-5 rounded-lg shadow transition-all hover:shadow-md #{selected_metric == 'conversions' ? 'ring-2 ring-indigo-500' : 'cursor-pointer'}" do %>
          <div class="flex items-center gap-1.5">
            <dt class="text-sm font-medium text-gray-500">Conversions</dt>
          </div>
          <dd class="mt-1">
            <span class="text-2xl font-semibold text-gray-900"><%= number_with_delimiter(totals[:conversions]) %></span>
            <% change = ((totals[:conversions] - prior[:conversions]).to_f / prior[:conversions] * 100).round(1) %>
            <span class="ml-2 text-sm <%= change >= 0 ? 'text-green-600' : 'text-red-600' %>">
              <%= change >= 0 ? '↑' : '↓' %> <%= change.abs %>%
            </span>
          </dd>
          <div class="mt-1 text-xs text-gray-400">vs <%= number_with_delimiter(prior[:conversions]) %> prior</div>
        <% end %>

        <%= link_to dashboard_path(request.query_parameters.merge(metric: "revenue")),
            class: "bg-white p-5 rounded-lg shadow transition-all hover:shadow-md #{selected_metric == 'revenue' ? 'ring-2 ring-indigo-500' : 'cursor-pointer'}" do %>
          <div class="flex items-center gap-1.5">
            <dt class="text-sm font-medium text-gray-500">Revenue</dt>
          </div>
          <dd class="mt-1">
            <span class="text-2xl font-semibold text-gray-900"><%= number_to_currency(totals[:revenue], precision: 0) %></span>
            <% change = ((totals[:revenue] - prior[:revenue]).to_f / prior[:revenue] * 100).round(1) %>
            <span class="ml-2 text-sm <%= change >= 0 ? 'text-green-600' : 'text-red-600' %>">
              <%= change >= 0 ? '↑' : '↓' %> <%= change.abs %>%
            </span>
          </dd>
          <div class="mt-1 text-xs text-gray-400">vs <%= number_to_currency(prior[:revenue], precision: 0) %> prior</div>
        <% end %>

        <%= link_to dashboard_path(request.query_parameters.merge(metric: "conversion_rate")),
            class: "bg-white p-5 rounded-lg shadow transition-all hover:shadow-md #{selected_metric == 'conversion_rate' ? 'ring-2 ring-indigo-500' : 'cursor-pointer'}" do %>
          <div class="flex items-center gap-1.5">
            <dt class="text-sm font-medium text-gray-500">Conversion Rate</dt>
          </div>
          <dd class="mt-1">
            <span class="text-2xl font-semibold text-gray-900"><%= totals[:conversion_rate] %>%</span>
            <% change = ((totals[:conversion_rate] - prior[:conversion_rate]) / prior[:conversion_rate] * 100).round(1) %>
            <span class="ml-2 text-sm <%= change >= 0 ? 'text-green-600' : 'text-red-600' %>">
              <%= change >= 0 ? '↑' : '↓' %> <%= change.abs %>%
            </span>
          </dd>
          <div class="mt-1 text-xs text-gray-400">vs <%= prior[:conversion_rate] %>% prior</div>
        <% end %>

        <%= link_to dashboard_path(request.query_parameters.merge(metric: "aov")),
            class: "bg-white p-5 rounded-lg shadow transition-all hover:shadow-md #{selected_metric == 'aov' ? 'ring-2 ring-indigo-500' : 'cursor-pointer'}" do %>
          <div class="flex items-center gap-1.5">
            <dt class="text-sm font-medium text-gray-500">Avg Order Value</dt>
          </div>
          <dd class="mt-1">
            <span class="text-2xl font-semibold text-gray-900"><%= number_to_currency(totals[:aov]) %></span>
            <% change = ((totals[:aov] - prior[:aov]) / prior[:aov] * 100).round(1) %>
            <span class="ml-2 text-sm <%= change >= 0 ? 'text-green-600' : 'text-red-600' %>">
              <%= change >= 0 ? '↑' : '↓' %> <%= change.abs %>%
            </span>
          </dd>
          <div class="mt-1 text-xs text-gray-400">vs <%= number_to_currency(prior[:aov]) %> prior</div>
        <% end %>
      </div>

      <!-- Time Series Chart -->
      <div class="bg-white p-6 rounded-lg shadow mb-6">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-lg font-medium text-gray-900">Channel Performance Over Time</h3>
          <div class="flex items-center gap-1.5">
            <div class="group relative">
              <svg class="w-4 h-4 text-gray-400 cursor-help" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
              <div class="hidden group-hover:block absolute z-10 w-56 p-2 text-xs text-gray-600 bg-white border border-gray-200 rounded shadow-lg right-0 top-6">
                Daily conversions by channel. Shows top 5 channels for clarity.
              </div>
            </div>
          </div>
        </div>
        <div id="time-series-chart"
          data-controller="chart"
          data-chart-type-value="line"
          data-chart-data-value="<%= data[:time_series].to_json %>"
          class="h-72">
        </div>
      </div>

      <!-- Attribution Chart (metric-driven) -->
      <% chart_metric = %w[revenue aov].include?(selected_metric) ? "revenue" : "credits" %>
      <% chart_title = { "conversions" => "Conversions", "revenue" => "Revenue", "conversion_rate" => "Conversions", "aov" => "Revenue" }[selected_metric] %>
      <div class="bg-white p-6 rounded-lg shadow mb-6">
        <div class="flex items-center justify-between mb-4">
          <h3 class="text-lg font-medium text-gray-900"><%= chart_title %> by Channel</h3>
          <div class="group relative">
            <svg class="w-4 h-4 text-gray-400 cursor-help" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <div class="hidden group-hover:block absolute z-10 w-56 p-2 text-xs text-gray-600 bg-white border border-gray-200 rounded shadow-lg right-0 top-6">
              <% @filter_params[:models].each do |model| %>
                <div class="<%= 'mb-1' unless model == @filter_params[:models].last %>">
                  <strong><%= model.name.titleize %></strong>: <%= attribution_model_description(model.algorithm) %>
                </div>
              <% end %>
            </div>
          </div>
        </div>
        <div id="channel-chart"
          data-controller="chart"
          data-chart-type-value="bar"
          data-chart-metric-value="<%= chart_metric %>"
          data-chart-drilldown-value="true"
          data-chart-campaigns-value="<%= data[:top_campaigns].to_json %>"
          data-chart-data-value="<%= data[:by_channel].to_json %>"
          class="h-80">
        </div>
      </div>

    <% else %>
      <div class="bg-red-50 p-4 rounded-lg">
        <p class="text-red-700">Error loading conversions data: <%= @result[:errors].join(', ') %></p>
      </div>
    <% end %>
  </div>
<% end %>
